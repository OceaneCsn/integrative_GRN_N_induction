---
title: "Integrative GRN inference tutorial"
output: html_document
---

Before being able to use weighteRF, the modified C++ Random Forest implementation have to be set up on your computer. To do so, run in your system terminal :

```R CMD SHLIB inference_functions/Cpp_dependencies/rfutils.c```
```R CMD SHLIB inference_functions/Cpp_dependencies/regTree.c```
```R CMD SHLIB inference_functions/Cpp_dependencies/regrf_mse.c```

The R packages that you will need to install are :
doParallel, parallel, foreach, doRNG, randomForest, igraph, boot, stringr, tictoc, GENIE3

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
source('inference_functions/weightedRF.R')
source('inference_functions/weightedLASSO.R')
source('inference_functions/evaluateNetwork.R')
```

This document demonstrates the use of the weightedRF and weightedLASSO functions for integrative GRN inference.

Those functions infer the regulatory pathways of *Arabidopsis thaliana*'s roots in response to nitrate (N) induction from [Varala et al., 2018](https://www.ncbi.nlm.nih.gov/geo/query/acc.cgi?acc=GSE97500).

They use as inputs the expression profiles of nitrate-responsive genes and TFBS information. 
Prior TFMS information was built by searching in the promoters of the nitrate-responsive genes (-1000 bp upstream and 200bp downstream of the TSS) the PWM of the N-responsive regulators found in the [JASPAR database](https://jaspar.genereg.net/). 

## Data import

### Expression data

Import of the expression data and the N-responsive genes and regulators :

```{r}
load('rdata/inference_input_N_response_varala.rdata')
genes <- input_data$grouped_genes; length(genes)
tfs <- input_data$grouped_regressors; length(tfs)
counts <- input_data$counts; dim(counts)
```

### TFBS data


```{r}
load("rdata/pwm_occurrences_N_response_varala.rdata")
dim(pwm_occurrence)
```

## GRN inference

The strength of data integration $\alpha$ (between 0 and 1) calibrates the contribution of TFBSs to expression data. It can be set globally (one numeric value) or in a gene-specific value (a named vector of $\alpha$ values giving the alpha specific to each gene).

### weightedRF : weighted Random Forests

As an example, let's infer a GRN using weightedRF with $\alpha=0.8$ for all genes and a density $D = 0.005$.
It is also parametrized by the number of trees nTrees.

```{r}
importances_rf <- weightedRF_inference(counts, genes, tfs, alpha = 0.8, nTrees = 500,
                             pwm_occurrence = pwm_occurrence, nCores = 25)

grn_RF <- weightedRF_network(importances_rf, density = 0.005, pwm_occurrence, genes, tfs)
  
head(grn_RF); dim(grn_RF)
mean(grn_RF$pwm)
```
Here, around 95% of inferred edges are supported by a PWM.

### weightedLASSO : LASSO with Differential Shrinkage and Stability Selection

Let's infer a GRN using weightedLASSO with $\alpha=0.8$ and a density $D = 0.005$.
It is also parametrized by N, the number of iterations of stability selection.


```{r}
importances_lasso <- weightedLASSO_inference(counts, genes, tfs, alpha = 0.8, N = 50,
                               pwm_occurrence = pwm_occurrence, nCores = 30)
grn_lasso <- weightedLASSO_network(importances_lasso, density = 0.005, 
                                       pwm_occurrence, genes, tfs, decreasing = TRUE)
head(grn_lasso); dim(grn_lasso)
mean(grn_lasso$pwm)
```


### Getting prediction error on target genes (MSE)

The error in predicting the expression of target genes during regressions in GRN inference is also assessed on test conditions and returned by the inference functions ("mse" row in the returned matrix) :

```{r}
data.frame(weightedRF = importances_rf["mse",],
            weightedLASSO = importances_lasso["mse",]) %>%
  reshape2::melt() %>%
  rename(normalized_mse = value, model = variable) %>%
  ggplot(aes(x= normalized_mse, fill = model)) +
  geom_histogram(alpha = 0.5) + theme_bw()

```

Here, the distribution of test errors across genes are quite similar between the two models.
The returned MSE is actually normalized by th evariance of the target gene, so it is comparable between target genes.

### Validating the GRNs against DAPSeq

The following function computes precision and recall on experimental TF-DNA *in vitro* interactions in Arabidopsis (DAP-Seq data):

```{r}
dapseq_validation <- evaluate_networks(list("bRF" = grn_RF, "LASSO-D3S" = grn_lasso), 
                                         input_genes = genes, input_tfs = tfs, 
                                         validation = c("DAPSeq"),
                                         nCores =2);dapseq_validation
```

In this example, approximately approximately 42% of predicted edges by weightedRF and 37% of weightedLASSO are supported by DAPSeq experiments.

> In agreement with the article results, we encourage the use of gene-specific alphas, that can be determined by finding for each gene the value of alpha offering low prediction error as a function data integration, as comapred to baseline (shuffled) data. This is demonstrated in another notebook of this repository, namely _weightedLASSO_weightedRF_gene_specific.Rmd_. 

